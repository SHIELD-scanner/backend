"""Unit tests for vulnerability API endpoints."""

import pytest
from fastapi.testclient import TestClient
from unittest.mock import Mock
from app.api.vulnerability import get_vulnerability_client
from app.models.vulnerability import Vulnerability


class TestVulnerabilityAPI:
    """Test cases for Vulnerability API endpoints."""

    @pytest.fixture
    def mock_client_dependency(self):
        """Mock the get_vulnerability_client dependency."""
        mock_client = Mock()
        return mock_client

    def test_list_vulnerabilities_no_filters(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/ with no filters."""
        mock_vulns = [
            Vulnerability(vulnerabilityID="CVE-1", severity="HIGH", score=7.0),
            Vulnerability(vulnerabilityID="CVE-2", severity="CRITICAL", score=9.0),
        ]
        mock_client_dependency.get_all.return_value = mock_vulns

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get("/vulnerabilities/")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        data = response.json()
        assert len(data) == 2
        assert data[0]["vulnerabilityID"] == "CVE-1"
        assert data[1]["vulnerabilityID"] == "CVE-2"
        mock_client_dependency.get_all.assert_called_once_with(
            namespace=None, cluster=None, severity=None
        )

    def test_list_vulnerabilities_with_filters(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/ with all filters."""
        mock_vulns = [
            Vulnerability(
                vulnerabilityID="CVE-1",
                severity="HIGH",
                score=7.0,
                namespace="test-ns",
                cluster="test-cluster",
            )
        ]
        mock_client_dependency.get_all.return_value = mock_vulns

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get(
                "/vulnerabilities/?namespace=test-ns&cluster=test-cluster&severity=HIGH"
            )
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        data = response.json()
        assert len(data) == 1
        assert data[0]["severity"] == "HIGH"
        mock_client_dependency.get_all.assert_called_once_with(
            namespace="test-ns", cluster="test-cluster", severity="HIGH"
        )

    def test_show_vulnerability_found(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/{hash} when vulnerability exists."""
        mock_vuln = Vulnerability(
            vulnerabilityID="CVE-2021-1234",
            severity="HIGH",
            score=7.5,
            hash="test-hash",
        )
        mock_client_dependency.get_by_hash.return_value = mock_vuln

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get("/vulnerabilities/test-hash")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        data = response.json()
        assert data["vulnerabilityID"] == "CVE-2021-1234"
        assert data["severity"] == "HIGH"
        mock_client_dependency.get_by_hash.assert_called_once_with("test-hash")

    def test_show_vulnerability_not_found(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/{hash} when vulnerability doesn't exist."""
        mock_client_dependency.get_by_hash.return_value = None

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get("/vulnerabilities/nonexistent-hash")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 404
        data = response.json()
        assert data["detail"] == "Vulnerability not found"
        mock_client_dependency.get_by_hash.assert_called_once_with("nonexistent-hash")

    def test_list_vulnerabilities_severity_filter(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/ with severity filter only."""
        mock_vulns = [
            Vulnerability(vulnerabilityID="CVE-1", severity="CRITICAL", score=9.0)
        ]
        mock_client_dependency.get_all.return_value = mock_vulns

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get("/vulnerabilities/?severity=CRITICAL")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        data = response.json()
        assert len(data) == 1
        assert data[0]["severity"] == "CRITICAL"
        mock_client_dependency.get_all.assert_called_once_with(
            namespace=None, cluster=None, severity="CRITICAL"
        )

    def test_list_vulnerabilities_empty_result(self, client, mock_client_dependency):
        """Test GET /vulnerabilities/ with empty result."""
        mock_client_dependency.get_all.return_value = []

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = (
            lambda: mock_client_dependency
        )

        try:
            response = client.get("/vulnerabilities/")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        data = response.json()
        assert data == []

    def test_dependency_injection_working(self, client):
        """Test that dependency injection is properly configured."""
        mock_client = Mock()
        mock_client.get_all.return_value = []

        # Override the dependency
        client.app.dependency_overrides[get_vulnerability_client] = lambda: mock_client

        try:
            response = client.get("/vulnerabilities/")
        finally:
            # Clean up the override
            client.app.dependency_overrides.clear()

        assert response.status_code == 200
        # Verify the mock was called
        mock_client.get_all.assert_called_once()
